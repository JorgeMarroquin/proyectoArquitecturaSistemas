kind: pipeline
type: docker
name: default


steps:
- name: test
  image: maven:3-jdk-11
  commands:
  - mvn install -DskipTests=true -Dmaven.javadoc.skip=true -B -V
  - mvn test -B

- name: sonar
  image: maven:3-jdk-11
  commands:
    - mvn clean install
    - mvn sonar:sonar -Dsonar.login=admin -Dsonar.password=Jmo=47558520 -Dsonar.host.url=http://104.43.137.120:9000/ -Dsonar.projectName=VentasDrone

- name: Quality-Gate
  image: maven:3-jdk-11
  commands:
    - mvn clean verify sonar:sonar sonar-quality-gate:check -Dsonar.login=admin -Dsonar.password=tzec99 -Dsonar.host.url=http://52.188.188.66:9000
  when:
    event:
      include:     
      - pull_request

- name: tomcatDEV
  image: maven:3-jdk-11
  commands:
    - mvn -Puat package
    - cd target/
    - stat ventas-0.0.1-SNAPSHOT.war
    - mv  ventas-0.0.1-SNAPSHOT.war dev.war
    - curl -v -u admin:admin -T dev.war 'http://104.43.137.120:8085/manager/text/deploy?path=/dev&update=true'
  when:
    branch:
      - dev

- name: tomcatUAT
  image: alpine
  commands:
    - cd target/
    - apk add curl
    - stat ventas-0.0.1-SNAPSHOT.war
    - mv  ventas-0.0.1-SNAPSHOT.war uat.war
    - curl -v -u admin:admin -T uat.war 'http://104.43.137.120:8086/manager/text/deploy?path=/uat&update=true'
  when:
    branch:
      - uat

- name: tomcatMAIN
  image: alpine
  commands:
    - cd target/
    - apk add curl
    - stat ventas-0.0.1-SNAPSHOT.war
    - mv  ventas-0.0.1-SNAPSHOT.war main.war
    - curl -v -u admin:admin -T main.war 'http://104.43.137.120:8087/manager/text/deploy?path=/main&update=true'
  when:
    branch:
      - main